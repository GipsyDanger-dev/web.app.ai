<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTFRUIT FINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: white; }
        .monitor {
            position: relative; width: 640px; height: 480px; margin: auto;
            border: 2px solid #334155; border-radius: 12px; overflow: hidden;
            background: #000;
        }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Mirror effect */
        video, canvas { transform: scaleX(-1); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center font-sans">

    <div class="mb-6 text-center">
        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">
            FASTFRUIT <span class="text-white text-xl">GRAPH MODE</span>
        </h1>
    </div>

    <div class="monitor shadow-[0_0_50px_rgba(0,255,0,0.1)]">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="output-canvas" width="640" height="480"></canvas>
    </div>

    <!-- Status Box -->
    <div class="mt-6 text-center w-full max-w-2xl px-4">
        <p id="status-text" class="text-blue-400 font-mono animate-pulse">Menghubungkan...</p>
        
        <!-- Hasil -->
        <div id="result-box" class="hidden flex justify-center gap-4 mt-4">
            <div class="bg-gray-800 px-6 py-3 rounded-lg border border-gray-600">
                <p class="text-xs text-gray-500 uppercase">PREDICTION</p>
                <h2 id="label-res" class="text-2xl font-bold text-white">-</h2>
            </div>
            <div class="bg-gray-800 px-6 py-3 rounded-lg border border-gray-600">
                <p class="text-xs text-gray-500 uppercase">CONFIDENCE</p>
                <h2 id="conf-res" class="text-2xl font-bold text-blue-400">-</h2>
            </div>
        </div>
    </div>

    <script>
        // === KONFIGURASI ===
        const CLASSES = [
            'Fresh Apple', 'Fresh Banana', 'Fresh Orange',
            'Rotten Apple', 'Rotten Banana', 'Rotten Orange'
        ];

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status-text');

        let model;

        async function main() {
            try {
                // 1. Setup Kamera
                statusText.innerText = "Membuka Kamera...";
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'environment' },
                    audio: false
                });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);

                // 2. LOAD MODEL (GRAPH MODEL)
                statusText.innerText = "Memuat Graph Model...";
                
                // PERHATIKAN: tf.loadGraphModel (Bukan loadLayersModel)
                model = await tf.loadGraphModel('/model_web/model.json');
                
                // Warmup
                statusText.innerText = "Menyiapkan GPU...";
                const zeros = tf.zeros([1, 224, 224, 3]);
                model.predict(zeros).dispose();
                zeros.dispose();

                statusText.innerText = "Sistem Siap!";
                statusText.classList.remove('animate-pulse');
                statusText.classList.add('text-green-500');
                document.getElementById('result-box').classList.remove('hidden');

                // 3. Mulai Loop
                detectFrame();

            } catch (err) {
                statusText.innerText = "ERROR: " + err.message;
                statusText.classList.add('text-red-500');
                console.error(err);
            }
        }

        async function detectFrame() {
            // Bersihkan canvas
            ctx.clearRect(0, 0, 640, 480);
            ctx.drawImage(video, 0, 0, 640, 480);

            if (model) {
                tf.tidy(() => {
                    // Preprocessing
                    const img = tf.browser.fromPixels(video)
                        .resizeBilinear([224, 224])
                        .div(tf.scalar(255))
                        .expandDims(0); // Tambah dimensi batch [1, 224, 224, 3]

                    // Prediksi
                    const result = model.predict(img);
                    const scores = result.dataSync(); // Ambil data
                    
                    // Cari nilai tertinggi
                    const maxScore = Math.max(...scores);
                    const maxIndex = scores.indexOf(maxScore);
                    
                    const label = CLASSES[maxIndex];
                    const confidence = (maxScore * 100).toFixed(1);

                    // Update UI
                    document.getElementById('label-res').innerText = label;
                    document.getElementById('conf-res').innerText = confidence + "%";
                    
                    // Gambar Kotak
                    const color = label.toLowerCase().includes("fresh") ? "#4ade80" : "#ef4444";
                    document.getElementById('label-res').style.color = color;
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 4;
                    ctx.strokeRect(100, 50, 440, 380);
                });
            }
            requestAnimationFrame(detectFrame);
        }

        main();
    </script>
</body>
</html>